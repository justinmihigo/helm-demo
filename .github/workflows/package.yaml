name: Sign and Push Helm Chart

on:
  push:
    tags:
      - v.*
    branches:
      - main
jobs:
  sign-and-push:
    runs-on: ubuntu-latest
    env:
      CHART_DIR: ./
      REGISTRY: ${{ secrets.HELM_REGISTRY }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Helm
      uses: azure/setup-helm@v4.3.0
      with:
        version: v3.14.3

    - name: list the private key
      run: gpg --list-keys

    - name: Import GPG private key
      run: |
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
      # env:
      #   GPG_PRIVATE_KEY:${{ secrets.GPG_PRIVATE_KEY }}

    - name: Package & sign chart
      run: |
        helm dependency update "$CHART_DIR"
        helm package "$CHART_DIR" \

          --sign --key "$SIGNING_KEY" --keyring ~/.gnupg/secring.pgp
      env:
        SIGNING_KEY: Mihigo
    