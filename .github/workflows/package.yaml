name: Sign and Push Helm Chart

on:
  push:
    tags:
      - 'v.*'
    branches:
      - main
jobs:
  sign-and-push:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      # with:
      #   fetch-depth: 0
    
    - name: Configure Git
      run: |
        git config user.name "justinmihigo"
        git config user.email "justinmihigo@users.noreply.github.com"
    
    - name: Set up Helm
      uses: azure/setup-helm@v4.3.0
      with:
        version: v3.14.3

    - name: Import GPG private key
      run: |
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | base64 -d | gpg --batch --import
    
    - name: Prepare GPG key #this step is for using exported keys and make your github runner
      run: |
        gpg_dir=.cr-gpg
        mkdir $gpg_dir
        echo "$GPG_PASSPHRASE" > .cr-gpg/passphrase #storing passphrase data into a file
        cat .cr-gpg/passphrase
        echo "${{secrets.SECRING_BASE64}}" | base64 -d > .cr-gpg/secring.gpg

      env:
        GPG_KEYRING_BASE64: "${{ secrets.GPG_PRIVATE_KEY }}" #Referring secrets of github above
        GPG_PASSPHRASE: "${{ secrets.GPG_PASSPHRASE }}"  

    - name: List files in gnupg
      run: |
        ls -la
        file .cr-gpg/passphrase
        file .cr-gpg/secring.gpg
        wc passphrase
        gpg --list-keys


    - name: Create secring.pgp to sign
      run: |
        gpg --export > .cr-gpg/pubring.gpg
    #     gpg --export-secret-key --pinentry-mode=loopback --yes --passphrase "kali"> ~/.gnupg/secring.gpg
    #     # cp .cr-gpg/secring.gpg ~/.gnupg/secring.gpg
    
    #     # cp ~/.gnupg/pubring.gpg .cr-gpg/pubring.gpg


    # - name: Move the repo to charts
    #   run: |
    #     mkdir charts
    #     find . -mindepth 1 -maxdepth 1 -name .git ! -name charts ! -name .cr-gpg -exec mv -t charts {} +
    # - name: Move CR folder to charts/templates
    #   run:  cp -rf .cr-gpg charts/templates

    - name: Characteristics for secring.gpg
      run: |
        file .cr-gpg/secring.gpg
        wc .cr-gpg/secring.gpg
        gpg --list-keys

        
    # - name: Add repositories
    #   run: |
    #     for dir in $(ls -d charts/*/); do
    #       helm dependency list $dir 2> /dev/null | tail +2 | head -n -1 | awk '{ print "helm repo add " $1 " " $3 }' | while read cmd; do $cmd; done
    #     done
      
    - name: Dependency update
      run: |
        cd charts
        helm dependency update
        
    # - name: Sign the package
    #   run: |
    #     helm package  --sign --key Mihigo --keyring ~/.gnupg/secring.gpg . --passphrase-file passphrase
    
    # - name: Upload the artifact to github
    #   uses: actions/upload-artifact@v4.3.0
    #   with:
    #     name: mychart-release
    #     path: |
    #       ./*tgz
    #       ./*prov

    - name: Run chart-releaser #this is used to generate new version of helm chart along with some file with extension .prov
      uses: helm/chart-releaser-action@v1.7.0
        
      env:
        CR_TOKEN: "${{ secrets.PAT }}"
        CR_KEY: "${{ secrets.CR_KEY }}" #Key name used while creating key
        CR_SIGN: true
        CR_SKIP_EXISTING: false
        CR_MARK_AS_LATEST: true



    # - name: Package & sign chart
    #   run: |
    #     helm dependency update "$CHART_DIR"
    #     helm package "$CHART_DIR" \
    #       --sign --key "$SIGNING_KEY" --keyring ~/.gnupg/secring.pgp
    #   env:
    #     SIGNING_KEY: Mihigo
    